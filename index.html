<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
	<title>Traffic Visualizer</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<link rel="stylesheet" type="text/css"
		href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.js"></script>
	<script src="https://rawgit.com/moment/moment/2.2.1/min/moment.min.js"></script>
	<script  rel="styesheet" src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-2/js/all.min.js"></script>
</head>

<body>
	<nav class="navbar navbar-dark fixed-top bg-dark flex-md-nowrap p-0 shaddow navbar-expand-xs">
		<a class="navbar-brand col-sm-4" href="#">Traffic Visualizer</a>
	</nav>

	<div class="container-fluid">
		<div class="row">
			<nav class="col-sm-12 col-md-3 col-lg-2 d-md-block bg-light sidebar">
				<div class="sidebar-sticky">
					<ul class="nav flex-column list-unstyled components">
						<li class="active">
							<a href="#I-205" data-toggle="collapse" role="navigation" aria-controls="I-205"
								aria-expanded="false">Freeways</a>
							<ul class="collapse list-unstyled" id="I-205">
								<li>
									<a href="#NORTH" data-toggle="collapse" aria-expanded="false"
										class="dropdown-toggle">I-205 Northbound</a>
									<ul class="collapse list-unstyled" id="NORTH">
										<li>
											<a id="Sunnyside NB" class="locations" href="#">Sunnyside Blvd</a>
										</li>
										<li>
											<a id="Johnson Cr NB" class="locations" href="#">Johnson Cr Rd</a>
										</li>
										<li>
											<a id="Foster NB" class="locations" href="#">Foster Rd</a>
										</li>
										<li>
											<a id="Powell to I-205 NB" class="locations" href="#">Powell Blvd</a>
										</li>
										<li>
											<a id="Division NB" class="locations" href="#">Division St</a>
										</li>
										<li>
											<a id="Glisan to I-205 NB" class="locations" href="#">Glisan St</a>
										</li>
										<li>
											<a id="Columbia to I-205 NB" class="locations" href="#">Columbia Blvd</a>
										</li>
									</ul>
								</li>
								<li>
									<a href="#SOUTH" data-toggle="collapse" aria-expanded="false"
										class="dropdown-toggle">I-205 Southbound</a>
									<ul class="collapse list-unstyled" id="SOUTH">
										<li>
											<a id="Sunnyside SB" class="locations" href="#">Sunnyside Rd</a>
										</li>
										<li>
											<a id="Johnson Creek SB" class="locations" href="#">Johnson Cr Rd</a>
										</li>
										<li>
											<a id="Foster SB" class="locations" href="#">Foster Rd</a>
										</li>
										<li>
											<a id="Powell Blvd SB" class="locations" href="#">Powell Blvd</a>
										</li>
										<li>
											<a id="Division SB" class="locations" href="#">Division St</a>
										</li>
										<li>
											<a id="Stark-Washington SB" class="locations" href="#">Stark St</a>
										</li>
										<li>
											<a id="Glisan to I-205 SB" class="locations" href="#">Glisan St</a>
										</li>
										<li>
											<a id="Columbia to I-205 SB" class="locations" href="#">Columbia Blvd</a>
										</li>
										<li>
											<a id="Airportway EB to SB" class="locations" href="#">Airport Way East</a>
										</li>
										<li>
											<a id="Airportway WB to SB" class="locations" href="#">Airport Way West</a>
										</li>
									</ul>
								</li>
							</ul>
						</li>
					</ul>
				</div>
			</nav>

			<main role="main" class="col-md-9 col-lg-10 ml-auto">
				<div class="container-fluid pt-5" id="large-container">
					<nav class="navbar navbar-expand-lg">
						<button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button"
							data-toggle="collapse" data-target="#navbarSupportedContent"
							aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
							<i class="far fa-calendar-alt"></i>
						</button>
						<div class="collapse navbar-collapse" id="navbarSupportedContent">
							<ul class="nav navbar-nav ml-auto">
								<li class="nav-item">
									<a id="prev" class="nav-link" href="#">
									<i class="fas fa-caret-left"></i></a>
								</li>
								<li class="nav-item">
									<a id="week" class="nav-link" href="#">Week 1</a>
								</li>
								<li class="nav-item">
									<a id="next" class="nav-link" href="#"> 
									<i class="fas fa-caret-right"></i></a>
								</li>
								<li class="nav-item">
									<a id="sunday" class="nav-link days" href="#">Sunday</a>
								</li>
								<li class="nav-item">
									<a id="monday" class="nav-link days" href="#">Monday</a>
								</li>
								<li class="nav-item">
									<a id="tuesday" class="nav-link days" href="#">Tuesday</a>
								</li>
								<li class="nav-item">
									<a id="wednesday" class="nav-link days" href="#">Wednesday</a>
								</li>
								<li class="nav-item">
									<a id="thursday" class="nav-link days" href="#">Thursday</a>
								</li>
								<li class="nav-item">
									<a id="friday" class="nav-link days" href="#">Friday</a>
								</li>
								<li class="nav-item">
									<a id="saturday" class="nav-link days" href="#">Saturday</a>
								</li>
							</ul>
						</div>
					</nav>

					<div class="mt-4 jumbotron jumbotron-fluid" id="jumbotron">
						<div class="container">
							<h1 class="display-4">Visualize Traffic from Sensor Data</h1>
							<p class="lead">Observe how traffic flows using sensors embeded in Portland freeways where speed and flow are
								recorded.</p>
							<hr class="my-4">
							<p>To use this API...</p>
							<p class="lead">
							</p>
						</div>
					</div>

					<div id="charts-maps" class="container">
						<div class="row row1">

							<div class="col-sm-12 col-md-12 col-lg-4 col-xl-4">
								<img class="card-img-top" id="satImg" alt="" src="">
								<div class="container" id="satView">
									<div class="card text-right border-light map-card">
										<div class="card-body">
											<h6 class="card-title" id="satViewTitle"></h6>
											<p id=satview-desc></p>
										</div>
									</div>
								</div>
							</div>

							<div class="col-sm-12 col-md-12 col-lg-8 col-xl-8">
								<canvas id="chartSpeed"></canvas>
								<div class="container" id="speedChart">
									<div class="card text-right border-light chart-card">
										<div class="card-body">
											<h6 class="card-title" id="speedChartTitle"></h6>
											<p id=speed-desc></p>
										</div>
									</div>
								</div>
							</div>

						</div>
						<div class="row row2">

							<div class="col-sm-12 col-md-12 col-lg-4 col-xl-4">
								<img class="card-img-top" id="streetImg" alt="" src="">
								<div class="container" id="streetView">
									<div class="card text-center border-light map-card">
										<div class="card-body">
											<a id="left" href="#" class="btn btn-primary">
												<i class="fas fa-arrow-left"></i>
											</a>
											<a id="right" href="#" class="btn btn-primary">
												<i class="fas fa-arrow-right"></i>
											</a>
											<h6 class="card-title" id="streetViewTitle"></h6>
											<p id=streetview-desc></p>
										</div>
									</div>
								</div>
							</div>

							<div class="col-sm-12 col-md-12 col-lg-8 col-xl-8">
								<canvas id="chartCongestion"></canvas>
								<div class="container" id="congestionChart">
									<div class="card text-right border-light chart-card">
										<div class="card-body">
											<h6 class="card-title" id="congestionChartTitle"></h6>
											<p id=congestion-desc></p>
										</div>
									</div>
								</div>
							</div>

						</div>
						<div class="row row3">

							<div class="col-sm-12 col-md-12 col-lg-4 col-xl-4"></div>

							<div class="col-sm-12 col-md-12 col-lg-8 col-xl-8">
								<canvas id="chartVolume"></canvas>
								<div class="container" id="volumeChart">
									<div class="card text-right border-light chart-card">
										<div class="card-body">
											<h6 class="card-title" id="volumeChartTitle"></h6>
											<p id=volume-desc></p>
										</div>
									</div>
								</div>
							</div>

						</div>

					</div> <!-- div charts-maps-->
				</div> <!-- container-fluid -->
			</main>
		</div> <!-- row nav and main-->
	</div> <!-- container-fluid  whole page-->

	<script type="text/javascript">
		window.onload = function () {
			document.getElementById("satView").hidden = true;
			document.getElementById("streetView").hidden = true;
			document.getElementById("volumeChart").hidden = true;
			document.getElementById("congestionChart").hidden = true;
			document.getElementById("speedChart").hidden = true;
		};

		let todaysHost = 'http://34.105.77.151';
		let mapsKey = 'AIzaSyAELBJSEp2P38z2vJKOJdXnfg-RebeM-zE';
		// on deploy
		// fetch('q1')
		// on development
		// fetch(`${proxyurl}/${todaysHost}/q1`)
		// or if cors used ...
		// fetch(`${todaysHost}/q1`)
		var chartSpeed;
		var chartVolume;
		var chartCongestion;
		var locations = document.querySelectorAll(".locations");
		var days = document.querySelectorAll(".days");

		for (let i = 0; i < locations.length; i++) 
			locations[i].onclick = function (e) {
				e.preventDefault();
				let location = this.id;
				let highway = this.parentNode.parentNode.parentNode.parentNode.id;
				let direction = this.parentNode.parentNode.id;

				let jumbo = document.getElementById("jumbotron");
				document.getElementById("jumbotron").remove();
				document.getElementById("large-container").appendChild(jumbo);

				document.getElementById("satView").hidden = false;
				document.getElementById("streetView").hidden = false;
				getMaps(direction, highway, location);
				destroyCharts();

				for (let i = 0; i < days.length; i++) 
					days[i].onclick = function (e) {
						e.preventDefault();
						let actives = document.getElementsByClassName("days active");
						for (let j = 0; j < actives.length; j++) 
							actives[j].classList.remove("active");
						let day = this.id;
						let week = document.getElementById("week").textContent.charAt(5);
						document.getElementById(day).classList.add("active");
						getCharts(direction, highway, location, 1, day, week);
					}
		}

		function destroyCharts() {
			if (chartVolume != null) chartVolume.destroy();
			if (chartSpeed != null) chartSpeed.destroy();
			if (chartCongestion != null) chartCongestion.destroy();
		}

		document.getElementById("prev").addEventListener("click", function (e) {
			e.preventDefault();
			let current = parseInt(document.getElementById("week").textContent.charAt(5))
			if (current == 1)
				document.getElementById("week").innerText = "Week 8";
			else
				document.getElementById("week").innerText = "Week " + --current;
		})
		
		document.getElementById("next").addEventListener("click", function (e) {
			e.preventDefault();
			let current = parseInt(document.getElementById("week").textContent.charAt(5));
			if (current == 8)
				document.getElementById("week").innerText = "Week 1";
			else
				document.getElementById("week").innerText = "Week " + ++current;
		})

		document.getElementById("left").addEventListener("click", function (e) {
			e.preventDefault();
			let streetImg = document.getElementById("streetImg");
			let re = /heading=(.)*&pitch/;
			let str = streetImg.src.match(re);
			let oldHeading = str[0].match(/\d+/);
			let newHeading = parseInt(oldHeading[0]) - 30;
			let newCall = streetImg.src.replace(re, "heading=" + newHeading + "&pitch");
			streetImg.src = newCall;
		});

		document.getElementById("right").addEventListener("click", function (e) {
			e.preventDefault();
			let streetImg = document.getElementById("streetImg");
			let re = /heading=(.)*&pitch/;
			let str = streetImg.src.match(re);
			let oldHeading = str[0].match(/\d+/);
			let newHeading = parseInt(oldHeading[0]) + 30;
			let newCall = streetImg.src.replace(re, "heading=" + newHeading + "&pitch");
			streetImg.src = newCall;
		});

		function getMaps(direction, highway, location) {
			fetch(`${todaysHost}/map/${direction}/${highway}/${location}`) //on deploy: fetch(`/map/${direction}/${highway}/${location}`)
				.then(response => { return response.json(); })
				.then(data => {
					let width = 800;
					let height = 600;
					let pitch = 0;
					let fov = 120;
					let heading;
					if (direction === 'NORTH') 
						heading = 360;
					else if (direction === 'SOUTH') 
						heading = 180;
					let lat = data.results.rows[0].latlong[0];
					let long = data.results.rows[0].latlong[1]

					let streetImg = document.getElementById("streetImg");
					streetImg.src = `https://maps.googleapis.com/maps/api/streetview?size=${width}x${height}&location=${lat},${long}&heading=${heading}&pitch=${pitch}&fov=${fov}&key=${mapsKey}`
					document.getElementById("streetImg").setAttribute("alt", location + ' street view from google maps');

					let zoom = 20;
					let satImg = document.getElementById("satImg");
					satImg.src = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${long}&zoom=${zoom}&size=${width}x${height}&maptype=hybrid&key=${mapsKey}`;
					document.getElementById("satViewTitle").innerText = location + " on " + highway;
					document.getElementById("satImg").setAttribute("alt", location + ' satellite view from google maps');
					return true;
				})
				.catch(error => {
					console.log('failed', error);
				})
		}

		function createChartVolume(totalVolume) {
			document.getElementById("volumeChart").hidden = false;
			document.getElementById("volumeChartTitle").innerText = "Number of vehicles per day";
			if (chartVolume != null) 
				chartVolume.destroy();
			document.getElementById('chartVolume').getContext('2d').clearRect(0, 0, this.width, this.height);
			chartVolume = new Chart(document.getElementById('chartVolume'), {
				type: 'doughnut',
				data: {
					labels: ['left'],
					datasets: [
						{
							label: 'Volume',
							backgroundColor: ['rgba(0, 0, 255, 0.8)'],
							data: [totalVolume]
						}
					]
				},
				options: {
					title: {
						display: true,
					}
				}
			});
		}

		function createChartSpeed(starttime, speed) {
			document.getElementById("speedChart").hidden = false;
			document.getElementById("speedChartTitle").innerText = "Speed";
			document.getElementById("speed-desc").innerText = "20-second averages in mph";
			if (chartSpeed != null)
				chartSpeed.destroy();
			chartSpeed = new Chart(document.getElementById("chartSpeed").getContext("2d"), {
				type: 'line',
				data: {
					labels: starttime,
					datasets: [{
						label: 'left',
						data: speed,
						borderColor: 'rgba(0, 0, 255, 0.8)',
						backgroundColor: 'rgba(0, 0, 255, 0.3)',
						fill: false,
						showLine: false,
						pointRadius: 1
					}]
				},
				options: {
					animation: {
						duration: 0
					},
					hover: {
						animationDuration: 0
					},
					responsiveAnimationDuration: 0
				},
				defaults: {
					line: {
						showLine: false,
					}
				}
			});
		}

		function createCongestionChart(starttime, occupancy) {
			document.getElementById("congestionChart").hidden = false;
			document.getElementById("congestionChartTitle").innerText = "Congestion";
			document.getElementById("congestion-desc").innerText = "percentage of time cars are on a sensor";
			if (chartCongestion != null) 
				chartCongestion.destroy();
			document.getElementById('chartCongestion').getContext('2d').clearRect(0, 0, this.width, this.height);
			chartCongestion = new Chart(document.getElementById("chartCongestion").getContext("2d"), {
				type: 'line',
				data: {
					labels: starttime,
					datasets: [{
						label: 'left',
						data: occupancy,
						borderColor: 'rgba(0, 0, 255, 0.8)',
						backgroundColor: 'rgba(0, 0, 255, 0.3)',
						fill: false,
						showLine: true,
						pointRadius: 1
					}]
				},
				options: {
					animation: {
						duration: 0.3
					},
					hover: {
						animationDuration: 0
					},
					responsiveAnimationDuration: 0
				},
				defaults: {
					line: {
						showLine: true,
					}
				}
			});
		}

		function getCharts(direction, highway, location, lane, day, week) {
			fetch(`${todaysHost}/data/${direction}/${highway}/${location}/${lane}/${day}/${week}`) //on deploy: fetch('data/${direction}/${highway}/${location}/${lane}/${day}/${week}')
				.then(response => { return response.json(); })
				.then(data => {
					returnedRows = data.results.rows;
					starttime = [];
					starttime = returnedRows.map(x => moment.utc((x['starttime'])).format('h:mm a'));
					speed = [];
					speed = returnedRows.map(x => x['speed']);
					volume = [];
					totalVolume = 0;
					volume = returnedRows.map(x => x['volume']);
					volume.forEach(v => totalVolume += v);
					occupancy = [];
					occupancy = returnedRows.map(x => x['occupancy']);
					let segment = Math.floor(occupancy.length / 48);
					occupancyAvg = [];
					for (let i = 0; i < occupancy.length; i += segment) {
						let tempBin = 0;
						for (let j = i; j < i + segment; j++) {
							tempBin += occupancy[j];
						}
						occupancyAvg.push(Math.round(tempBin /= segment));
					}
					timeSlices = [];
					for (let i = 0; i < starttime.length; i += segment) {
						timeSlices.push(starttime[i]);
					}

					createChartSpeed(starttime, speed);
					createCongestionChart(timeSlices, occupancyAvg);
					createChartVolume(totalVolume);

					return fetch(`${todaysHost}/data/${direction}/${highway}/${location}/${lane + 1}/${day}/${week}`) //on deploy: fetch('data/${direction}/${highway}/${location}/${lane}/${day}/${week}')
				})
				.then(response => { return response.json(); })
				.then(data => {
					returnedRows = data.results.rows;
					speed = [];
					speed = returnedRows.map(x => x['speed']);
					volume = [];
					totalVolume = 0;
					volume = returnedRows.map(x => x['volume']);
					volume.forEach(v => totalVolume += v);
					occupancy = returnedRows.map(x => x['occupancy']);
					let segment = Math.floor(occupancy.length / 48);
					occupancyAvg = [];
					for (let i = 0; i < occupancy.length; i += segment) {
						let tempBin = 0;
						for (let j = i; j < i + segment; j++) {
							tempBin += occupancy[j];
						}
						occupancyAvg.push(Math.round(tempBin /= segment));
					}

					anotherSpeed = {
						label: 'middle',
						data: speed,
						borderColor: 'rgba(0, 255, 0, 0.8)',
						backgroundColor: 'rgba(0, 255, 0, 0.3)',
						fill: false,
						showLine: false,
						pointRadius: 1
					}
					label = 'middle';
					backgroundColor = 'rgba(0, 255, 0, 0.8)';
					anotherCongestion = {
						label: 'middle lane',
						data: occupancyAvg,
						borderColor: 'rgba(0, 255, 0, 0.8)',
						backgroundColor: 'rgba(0, 255, 0, 0.3)',
						fill: false,
						showLine: true,
						pointRadius: 1
					}

					chartSpeed.data.datasets.push(anotherSpeed);
					chartSpeed.update(0);
					chartVolume.data.labels.push(label);
					chartVolume.data.datasets[0].data.push(totalVolume);
					chartVolume.data.datasets[0].backgroundColor.push(backgroundColor);
					chartVolume.update(0);
					chartCongestion.data.datasets.push(anotherCongestion);
					chartCongestion.update(0);
					return fetch(`${todaysHost}/data/${direction}/${highway}/${location}/${lane + 2}/${day}/${week}`) //on deploy: fetch('data/${direction}/${highway}/${location}/${lane+3}/${day}/${week}')
				})
				.then(response => { return response.json(); })
				.then(data => {
					returnedRows = data.results.rows;
					speed = [];
					speed = returnedRows.map(x => x['speed']);
					volume = [];
					totalVolume = 0;
					volume = returnedRows.map(x => x['volume']);
					volume.forEach(v => totalVolume += v);
					occupancy = returnedRows.map(x => x['occupancy']);
					let segment = Math.floor(occupancy.length / 48);
					occupancyAvg = [];
					for (let i = 0; i < occupancy.length; i += segment) {
						let tempBin = 0;
						for (let j = i; j < i + segment; j++) {
							tempBin += occupancy[j];
						}
						occupancyAvg.push(Math.round(tempBin /= segment));
					}

					anotherSpeed = {
						label: 'right',
						data: speed,
						borderColor: 'rgba(255, 0, 0, 0.8)',
						backgroundColor: 'rgba(255, 0, 0, 0.3)',
						fill: false,
						showLine: false,
						pointRadius: 1
					}
					label = 'right';
					backgroundColor = 'rgba(255, 0, 0, 0.8)';
					anotherCongestion = {
						label: 'right',
						data: occupancyAvg,
						borderColor: 'rgba(255, 0, 0, 0.8)',
						backgroundColor: 'rgba(255, 0, 0, 0.3)',
						fill: false,
						showLine: true,
						pointRadius: 1
					}

					chartSpeed.data.datasets.push(anotherSpeed);
					chartSpeed.update(0);
					chartVolume.data.labels.push(label);
					chartVolume.data.datasets[0].data.push(totalVolume);
					chartVolume.data.datasets[0].backgroundColor.push(backgroundColor);
					chartVolume.update(0);
					chartCongestion.data.datasets.push(anotherCongestion);
					chartCongestion.update(0);
				})
				.catch(error => {
					console.log('failed', error)
				})
		}
	</script>

	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
		integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
		crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
		integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
		crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
		integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
		crossorigin="anonymous"></script>
	<script>
		$('.navbar-nav>li>a:gt(2)').on('click', function(e){
			$('.navbar-collapse').collapse('hide');
		});
	</script>

</body>
</html>