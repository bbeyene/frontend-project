<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
	<title>Portland Traffic</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.js"></script>
	<script src="https://rawgit.com/moment/moment/2.2.1/min/moment.min.js"></script>
</head>
<body>
	    <div class="wrapper">
        <nav id="sidebar">
            <div class="sidebar-header">
                <h3>Portland Traffic</h3>
            </div>
            <ul class="list-unstyled components">
                <li class="active">
                    <a href="#freewaySubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Freeways</a>
                    <ul class="collapse list-unstyled" id="freewaySubmenu">
                        <li>
							<a href="#northSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">I-205 Northbound</a>
							<ul class="collapse list-unstyled" id="northSubmenu">
								<li>
									<a href="#">Johnson Rd</a>
								</li>
								<li>
									<a href="#">Foster Rd</a>
								</li>
							</ul>
						</li>
                        <li>
							<a href="#southSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">I-205 Northbound</a>
							<ul class="collapse list-unstyled" id="southSubmenu">
								<li>
									<a href="#">Sunnyside Rd</a>
								</li>
								<li>
									<a href="#">Airport Way</a>
								</li>
							</ul>
						</li>
                    </ul>
                </li>
                <li>
                    <a href="#anotherSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Pages</a>
                    <ul class="collapse list-unstyled" id="anotherSubmenu">
                        <li>
                            <a href="#">Page 1</a>
                        </li>
                        <li>
                            <a href="#">Page 2</a>
                        </li>
                        <li>
                            <a href="#">Page 3</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </nav>

        <div id="content">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">

                    <button type="button" id="sidebarCollapse" class="btn btn-info">
                        <i class="fas fa-align-left"></i>
                        <span><></span>
                    </button>
                    <button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                        <i class="fas fa-align-justify"></i>
                    </button>

                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="nav navbar-nav ml-auto">
                            <li class="nav-item active">
                                <a id="sunday" class="nav-link" href="#">Sunday</a>
                            </li>
                            <li class="nav-item">
                                <a id="monday" class="nav-link" href="#">Monday</a>
                            </li>
                            <li class="nav-item">
                                <a id="tuesday" class="nav-link" href="#">Tuesday</a>
                            </li>
                            <li class="nav-item">
                                <a id="wednesday" class="nav-link" href="#">Wednesday</a>
                            </li>
                            <li class="nav-item">
                                <a id="thursday" class="nav-link" href="#">Thursday</a>
                            </li>
                            <li class="nav-item">
                                <a id="friday" class="nav-link" href="#">Friday</a>
                            </li>
                            <li class="nav-item">
                                <a id="saturday" class="nav-link" href="#">Saturday</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

			<div id="info">
            <h2>Visualize Traffic from Sensor Data</h2>
            <p>The dark rings on the asphalt on Portland roads and freeways are sensors that measure vehicle presence and speed ...</p>
            <p>Choose a location from the sidebar to see what the sensors reported from millions of data points ...</p>

            <h2>Data and Storage</h2>
			<p>The data from these charts comes from ...</p>
			</div>

			<h2>Speed</h2>
			<div class="container">
				<canvas id="chartSpeed"></canvas>
			</div>
			<h2>Volume</h2>
			<div class="container">
				<canvas id="chartVolume"></canvas>
			</div>
			<h2>Travel Time</h2>
			<div class="container">
				<canvas id="chartTravelTime"></canvas>
			</div>

        </div>
    </div>



	<script type="text/javascript">

		// on development
		let todaysHost = 'http://34.105.76.204'
		// stackoverflow.com/questions/43871637/no-access-control-allow-origin-header-is-present-on-the-requested-resource-whe

		// on deploy
		// fetch('q1')
		// on development
		// fetch(`${proxyurl}/${todaysHost}/q1`)
		// or if cors used ...
		// fetch(`${todaysHost}/q1`)

		var chartSpeed;
		var chartVolume;
		var navlinks = document.querySelectorAll(".nav-link");
		for(let i = 0; i < navlinks.length; i++) { navlinks[i].onclick = function () { console.log("hi"); } }
		document.getElementById("sunday").onclick = function () {
			document.getElementById("info").hidden = true;
			fetch(`${todaysHost}/detectors/1345/sunday`) //fetch('detectors/1345/sunday')
				.then(response => { return response.json(); })
				.then(data => {
					returnedRows = data.results.rows;
					starttime = [];
					starttime = returnedRows.map(x => moment.utc((x['starttime'])).format('h:mm a'));
					speed = [];
					speed = returnedRows.map(x => x['speed']);
					volume = [];
					totalVolume = 0;
					volume = returnedRows.map(x => x['volume']);
					volume.forEach(v => totalVolume += v);

					chartVolume = new Chart(document.getElementById('chartVolume'), {
						type: 'doughnut',
						data: {
							labels: ['lane 1'],
							datasets: [
								{
									label: 'Volume',
									backgroundColor: ['rgba(0, 0, 255, 0.8)'],
									data: [totalVolume]
								}
							]
						},
						options: {
							title: {
								display: true,
								text: 'Number of Vehicles'
							}
						}
					});


				// speedvolume
					speedVolume = [];
					volumeSpeed = [];
					vs = [];
					for(let i = 0; i < speed.length; i++)
						if((volume[i] != undefined) && (speed[i]) != undefined) 
							vs.push({'volume': volume[i], 'speed': speed[i]});
					vs.sort(function(a,b) {
						return ((a.speed < b.speed) ? -1 : 1)
					});
					for(let i = 0; i < vs.length; i++) {
						speedVolume[i] = vs[i].speed;
						volumeSpeed[i] = vs[i].volume;
					}
					chartSpeedVolume = new Chart(document.getElementById("chartTravelTime").getContext("2d"), {
						type: 'line',
						data: {
							labels: speedVolume,
							datasets: [{
								label: 'flow rate',
								data: volumeSpeed,
								pointRadius: 3
							}]
						},
						options: {
							animation: {
								duration: 0
							},
							hover: {
								animationDuration: 0 
							},
							responsiveAnimationDuration: 0,
						},
						defaults: {
							line: {
								showLine: false,
							}
						}
					});
					

					chartSpeed = new Chart(document.getElementById("chartSpeed").getContext("2d"), {
						type: 'line',
						data: {
							labels: starttime,
							datasets: [{
								label: 'lane 1',
								data: speed,
								borderColor: 'rgba(0, 0, 255, 0.8)',
								backgroundColor: 'rgba(0, 0, 255, 0.3)',
								fill: false,
								showLine: false,
								pointRadius: 1
							}]
						},
						options: {
							animation: {
								duration: 0
							},
							hover: {
								animationDuration: 0
							},
							responsiveAnimationDuration: 0
						},
						defaults: {
							line: {
								showLine: false,
							}
						}
					});
					return fetch(`${todaysHost}/detectors/1346/sunday`); //fetch('detectors/1346/sunday')
				})
				.then(response => { return response.json(); })
				.then(data => {
					returnedRows = data.results.rows;
					speed = [];
					speed = returnedRows.map(x => x['speed']);
					volume = [];
					totalVolume = 0;
					volume = returnedRows.map(x => x['volume']);
					volume.forEach(v => totalVolume += v);

					anotherSpeed = {
						label: 'lane 2',
						data: speed,
						borderColor: 'rgba(0, 255, 0, 0.8)',
						backgroundColor: 'rgba(0, 255, 0, 0.3)',
						fill: false,
						showLine: false,
						pointRadius: 1
					}

					label = 'lane 2';
					backgroundColor = 'rgba(0, 255, 0, 0.8)';

					chartSpeed.data.datasets.push(anotherSpeed);
					chartSpeed.update(0);

					chartVolume.data.labels.push(label);
					chartVolume.data.datasets[0].data.push(totalVolume);
					chartVolume.data.datasets[0].backgroundColor.push(backgroundColor);
					chartVolume.update(0);
					return fetch(`${todaysHost}/detectors/1348/sunday`); //fetch('detectors/1348/sunday')
				})
				.then(response => { return response.json(); })
				.then(data => {
					returnedRows = data.results.rows;
					speed = [];
					speed = returnedRows.map(x => x['speed']);
					volume = [];
					totalVolume = 0;
					volume = returnedRows.map(x => x['volume']);
					volume.forEach(v => totalVolume += v);


					anotherSpeed = {
						label: 'lane 3',
						data: speed,
						borderColor: 'rgba(255, 0, 0, 0.8)',
						backgroundColor: 'rgba(255, 0, 0, 0.3)',
						fill: false,
						showLine: false,
						pointRadius: 1
					}
					label = 'lane 3';
					backgroundColor = 'rgba(255, 0, 0, 0.8)';

					chartSpeed.data.datasets.push(anotherSpeed);
					chartSpeed.update(0);
					chartVolume.data.labels.push(label);
					chartVolume.data.datasets[0].data.push(totalVolume);
					chartVolume.data.datasets[0].backgroundColor.push(backgroundColor);
					chartVolume.update(0);
				})
				.catch(error => {
					console.log('failed', error)
				})
		}

	</script>

    <!-- jQuery CDN - Slim version (=without AJAX) -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <!-- Popper.JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
    <!-- jQuery Custom Scroller CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            $("#sidebar").mCustomScrollbar({
                theme: "minimal"
            });

            $('#sidebarCollapse').on('click', function () {
                $('#sidebar, #content').toggleClass('active');
                $('.collapse.in').toggleClass('in');
                $('a[aria-expanded=true]').attr('aria-expanded', 'false');
            });
        });
    </script>

</body>
</html>
