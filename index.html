<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
	<title>Portland Traffic</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<link rel="stylesheet" type="text/css"
		href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.js"></script>
	<script src="https://rawgit.com/moment/moment/2.2.1/min/moment.min.js"></script>
</head>

<body>
	<div class="wrapper">
		<nav id="sidebar">
			<div class="sidebar-header">
				<h3>Portland Traffic</h3>
			</div>
			<ul class="list-unstyled components">
				<li class="active">
					<a href="#I-205" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Freeways</a>
					<ul class="collapse list-unstyled" id="I-205">
						<li>
							<a href="#NORTH" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">I-205	Northbound</a>
							<ul class="collapse list-unstyled" id="NORTH">
								<li>
									<a id="Columbia to I-205 NB" class="locations" href="#">Columbia Blvd</a>
								</li>
								<li>
									<a id="Division NB" class="locations" href="#">Division St</a>
								</li>
								<li>
									<a id="Foster NB" class="locations" href="#">Foster Rd</a>
								</li>
								<li>
									<a id="Glisan to I-205 NB" class="locations" href="#">Glisan St</a>
								</li>
								<li>
									<a id="Johnson Cr NB" class="locations" href="#">Johnson Cr Rd</a>
								</li>
								<li>
									<a id="Powell to I-205 NB" class="locations" href="#">Powell Blvd</a>
								</li>
								<li>
									<a id="Sunnyside NB" class="locations" href="#">Sunnyside Rd</a>
								</li>
							</ul>
						</li>
						<li>
							<a href="#SOUTH" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">I-205 Southbound</a>
							<ul class="collapse list-unstyled" id="SOUTH">
								<li>
									<a id="Airportway EB to SB" class="locations" href="#">Airport Way East</a>
								</li>
								<li>
									<a id="Airportway WB to SB" class="locations" href="#">Airport Way West</a>
								</li>
								<li>
									<a id="Columbia to I-205 SB" class="locations" href="#">Columbia Blvd</a>
								</li>
								<li>
									<a id="Division SB" class="locations" href="#">Division St</a>
								</li>
								<li>
									<a id="Foster SB" class="locations" href="#">Foster Rd</a>
								</li>
								<li>
									<a id="Glisan to I-205 SB" class="locations" href="#">Glisan St</a>
								</li>
								<li>
									<a id="Johnson Creek SB" class="locations" href="#">Johnson Cr Rd</a>
								</li>
								<li>
									<a id="Powell Blvd SB" class="locations" href="#">Powell Blvd</a>
								</li>
								<li>
									<a id="Stark/Washington SB" class="locations" href="#">Stark St</a>
								</li>
								<li>
									<a id="Sunnyside SB" class="locations" href="#">Sunnyside Rd</a>
								</li>
							</ul>
						</li>
					</ul>
				</li>
				<li>
					<a href="#anotherSubmenu" data-toggle="collapse" aria-expanded="false"
						class="dropdown-toggle">Pages</a>
					<ul class="collapse list-unstyled" id="anotherSubmenu">
						<li>
							<a href="#">Page 1</a>
						</li>
						<li>
							<a href="#">Page 2</a>
						</li>
						<li>
							<a href="#">Page 3</a>
						</li>
					</ul>
				</li>
				<li>
					<a href="#">Contact</a>
				</li>
			</ul>
		</nav>

		<div id="content">
			<nav class="navbar navbar-expand-lg navbar-light bg-light">
				<div class="container-fluid">

					<button type="button" id="sidebarCollapse" class="btn btn-info">
						<i class="fas fa-align-left"></i>
						<span>Menu</span>
					</button>
					<button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse"
						data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
						aria-expanded="false" aria-label="Toggle navigation">
						<i class="fas fa-align-justify"></i>
					</button>

					<div class="collapse navbar-collapse" id="navbarSupportedContent">
						<ul class="nav navbar-nav ml-auto">
							<li class="nav-item active">
								<a id="sunday" class="nav-link" href="#">Sunday</a>
							</li>
							<li class="nav-item">
								<a id="monday" class="nav-link" href="#">Monday</a>
							</li>
							<li class="nav-item">
								<a id="tuesday" class="nav-link" href="#">Tuesday</a>
							</li>
							<li class="nav-item">
								<a id="wednesday" class="nav-link" href="#">Wednesday</a>
							</li>
							<li class="nav-item">
								<a id="thursday" class="nav-link" href="#">Thursday</a>
							</li>
							<li class="nav-item">
								<a id="friday" class="nav-link" href="#">Friday</a>
							</li>
							<li class="nav-item">
								<a id="saturday" class="nav-link" href="#">Saturday</a>
							</li>
						</ul>
					</div>
				</div>
			</nav>

			<div id="info">
				<h2>Visualize Traffic from Sensor Data</h2>
				<p>The dark rings on the asphalt on Portland roads and freeways are sensors that measure vehicle
					presence and speed ...</p>
				<p>Choose a location from the sidebar to see what the sensors reported from millions of data points ...
				</p>

				<h2>Data and Storage</h2>
				<p>The data from these charts comes from ...</p>
			</div>

			<h2>Map</h2>
			<div id="map"></div>

			<h2>Speed</h2>
			<div class="container">
				<canvas id="chartSpeed"></canvas>
			</div>

			<h2>Volume</h2>
			<div class="container">
				<canvas id="chartVolume"></canvas>
			</div>
			<h2>Travel Time</h2>
			<div class="container">
				<canvas id="chartTravelTime"></canvas>
			</div>

		</div>
	</div>



	<script type="text/javascript">
		let todaysHost = 'http://34.105.76.204'
		let mapsKey = '';
		// on deploy
		// fetch('q1')
		// on development
		// fetch(`${proxyurl}/${todaysHost}/q1`)
		// or if cors used ...
		// fetch(`${todaysHost}/q1`)
		var map;
		var chartSpeed;
		var chartVolume;
		var chartTravelTime;
		var locations = document.querySelectorAll(".locations");
		var navlinks = document.querySelectorAll(".nav-link");


		for (let i = 0; i < locations.length; i++) locations[i].onclick = function () {
			let location = this.id;
			let highway = this.parentNode.parentNode.parentNode.parentNode.id;
			let direction = this.parentNode.parentNode.id;

			//dim chart if already visible
			getMaps(direction, highway, location);

			for (let i = 0; i < navlinks.length; i++) navlinks[i].onclick = function () {
				let day = this.id;
				getCharts(direction, highway, location, 1, day);
			}
		}

		function getMaps(direction, highway, location) {
			fetch(`${todaysHost}/map/${direction}/${highway}/${location}`) //on deploy: fetch(`/map/${direction}/${highway}/${location}`)
				.then(response => { return response.json(); })
				.then(data => {
					let width = 400;
					let height = 300;
					let pitch = 0;
					let fov = 120;
					let heading;
					if(direction === 'NORTH') heading = 0;
					else if(direction === 'SOUTH') heading = 180;
					let lat = data.results.rows[0].latlong[0];
					let long = data.results.rows[0].latlong[1]
					let img = document.createElement("img");
					img.src = `https://maps.googleapis.com/maps/api/streetview?size=${width}x${height}&location=${lat},${long}&heading=${heading}&pitch=${pitch}&fov=${fov}&key=${mapsKey}`
					document.getElementById("map").appendChild(img);
				})
				.catch(error => {
					console.log('failed', error);
				})
		}

		function getCharts(direction, highway, location, lane, day) {
			document.getElementById("info").hidden = true;
			console.log(lane);
			fetch(`${todaysHost}/data/${direction}/${highway}/${location}/${lane}/${day}`) //on deploy: fetch('data/${direction}/${highway}/${location}/${lane}/${day}')
				.then(response => { return response.json(); })
				.then(data => {
					returnedRows = data.results.rows;
					starttime = [];
					starttime = returnedRows.map(x => moment.utc((x['starttime'])).format('h:mm a'));
					speed = [];
					speed = returnedRows.map(x => x['speed']);
					volume = [];
					totalVolume = 0;
					volume = returnedRows.map(x => x['volume']);
					volume.forEach(v => totalVolume += v);

					if(chartVolume != null) chartVolume.destroy();
					document.getElementById('chartVolume').getContext('2d').clearRect(0, 0, this.width, this.height);
					chartVolume = new Chart(document.getElementById('chartVolume'), {
						type: 'doughnut',
						data: {
							labels: ['lane 1'],
							datasets: [
								{
									label: 'Volume',
									backgroundColor: ['rgba(0, 0, 255, 0.8)'],
									data: [totalVolume]
								}
							]
						},
						options: {
							title: {
								display: true,
								text: 'Number of Vehicles'
							}
						}
					});
					if(chartSpeed!= null) chartSpeed.destroy();
					chartSpeed = new Chart(document.getElementById("chartSpeed").getContext("2d"), {
						type: 'line',
						data: {
							labels: starttime,
							datasets: [{
								label: 'lane 1',
								data: speed,
								borderColor: 'rgba(0, 0, 255, 0.8)',
								backgroundColor: 'rgba(0, 0, 255, 0.3)',
								fill: false,
								showLine: false,
								pointRadius: 1
							}]
						},
						options: {
							animation: {
								duration: 0
							},
							hover: {
								animationDuration: 0
							},
							responsiveAnimationDuration: 0
						},
						defaults: {
							line: {
								showLine: false,
							}
						}
					});
					speedVolume = [];
					volumeSpeed = [];
					vs = [];
					for (let i = 0; i < speed.length; i++)
						if ((volume[i] != undefined) && (speed[i]) != undefined)
							vs.push({ 'volume': volume[i], 'speed': speed[i] });
					vs.sort(function (a, b) {
						return ((a.speed < b.speed) ? -1 : 1)
					});
					for (let i = 0; i < vs.length; i++) {
						speedVolume[i] = vs[i].speed;
						volumeSpeed[i] = vs[i].volume;
					}
					if(chartTravelTime!= null) chartTravelTime.destroy();
					document.getElementById('chartTravelTime').getContext('2d').clearRect(0, 0, this.width, this.height);
					chartTravelTime = new Chart(document.getElementById("chartTravelTime").getContext("2d"), {
						type: 'line',
						data: {
							labels: speedVolume,
							datasets: [{
								label: 'flow rate',
								data: volumeSpeed,
								pointRadius: 3
							}]
						},
						options: {
							animation: {
								duration: 0
							},
							hover: {
								animationDuration: 0
							},
							responsiveAnimationDuration: 0,
						},
						defaults: {
							line: {
								showLine: false,
							}
						}
					});
					return fetch(`${todaysHost}/data/${direction}/${highway}/${location}/${lane + 1}/${day}`) //on deploy: fetch('data/${direction}/${highway}/${location}/${lane}/${day}')
				})
				.then(response => { return response.json(); })
				.then(data => {
					returnedRows = data.results.rows;
					speed = [];
					speed = returnedRows.map(x => x['speed']);
					volume = [];
					totalVolume = 0;
					volume = returnedRows.map(x => x['volume']);
					volume.forEach(v => totalVolume += v);

					anotherSpeed = {
						label: 'lane 2',
						data: speed,
						borderColor: 'rgba(0, 255, 0, 0.8)',
						backgroundColor: 'rgba(0, 255, 0, 0.3)',
						fill: false,
						showLine: false,
						pointRadius: 1
					}
					label = 'lane 2';
					backgroundColor = 'rgba(0, 255, 0, 0.8)';

					chartSpeed.data.datasets.push(anotherSpeed);
					chartSpeed.update(0);
					chartVolume.data.labels.push(label);
					chartVolume.data.datasets[0].data.push(totalVolume);
					chartVolume.data.datasets[0].backgroundColor.push(backgroundColor);
					chartVolume.update(0);
					return fetch(`${todaysHost}/data/${direction}/${highway}/${location}/${lane + 2}/${day}`) //on deploy: fetch('data/${direction}/${highway}/${location}/${lane+3}/${day}')
				})
				.then(response => { return response.json(); })
				.then(data => {
					returnedRows = data.results.rows;
					speed = [];
					speed = returnedRows.map(x => x['speed']);
					volume = [];
					totalVolume = 0;
					volume = returnedRows.map(x => x['volume']);
					volume.forEach(v => totalVolume += v);


					anotherSpeed = {
						label: 'lane 3',
						data: speed,
						borderColor: 'rgba(255, 0, 0, 0.8)',
						backgroundColor: 'rgba(255, 0, 0, 0.3)',
						fill: false,
						showLine: false,
						pointRadius: 1
					}
					label = 'lane 3';
					backgroundColor = 'rgba(255, 0, 0, 0.8)';

					chartSpeed.data.datasets.push(anotherSpeed);
					chartSpeed.update(0);
					chartVolume.data.labels.push(label);
					chartVolume.data.datasets[0].data.push(totalVolume);
					chartVolume.data.datasets[0].backgroundColor.push(backgroundColor);
					chartVolume.update(0);
				})
				.catch(error => {
					console.log('failed', error)
				})
		}
	</script>

	<!-- jQuery CDN - Slim version (=without AJAX) -->
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
		integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
		crossorigin="anonymous"></script>
	<!-- Popper.JS -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"
		integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
		crossorigin="anonymous"></script>
	<!-- Bootstrap JS -->
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"
		integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
		crossorigin="anonymous"></script>
	<!-- jQuery Custom Scroller CDN -->
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>

	<script type="text/javascript">
		$(document).ready(function () {
			$("#sidebar").mCustomScrollbar({
				theme: "minimal"
			});

			$('#sidebarCollapse').on('click', function () {
				$('#sidebar, #content').toggleClass('active');
				$('.collapse.in').toggleClass('in');
				$('a[aria-expanded=true]').attr('aria-expanded', 'false');
			});
		});
	</script>
</body>
</html>
