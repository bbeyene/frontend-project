<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
	<title>Portland Traffic</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<link rel="stylesheet" type="text/css"
		href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.js"></script>
	<script src="https://rawgit.com/moment/moment/2.2.1/min/moment.min.js"></script>
</head>

<body>
	<div class="wrapper"></div>
	<nav id="sidebar">
		<div class="sidebar-header">
			<h3>Traffic Vizualizer</h3>
		</div>
		<ul class="list-unstyled components">
			<li class="active">
				<a href="#I-205" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Freeways</a>
				<ul class="collapse list-unstyled" id="I-205">
					<li>
						<a href="#NORTH" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">I-205 Northbound</a>
						<ul class="collapse list-unstyled" id="NORTH">
							<li>
								<a id="Columbia to I-205 NB" class="locations" href="#">Columbia Blvd</a>
							</li>
							<li>
								<a id="Division NB" class="locations" href="#">Division St</a>
							</li>
							<li>
								<a id="Foster NB" class="locations" href="#">Foster Rd</a>
							</li>
							<li>
								<a id="Glisan to I-205 NB" class="locations" href="#">Glisan St</a>
							</li>
							<li>
								<a id="Johnson Cr NB" class="locations" href="#">Johnson Cr Rd</a>
							</li>
							<li>
								<a id="Powell to I-205 NB" class="locations" href="#">Powell Blvd</a>
							</li>
							<li>
								<a id="Sunnyside NB" class="locations" href="#">Sunnyside Rd</a>
							</li>
						</ul>
					</li>
					<li>
						<a href="#SOUTH" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">I-205 Southbound</a>
						<ul class="collapse list-unstyled" id="SOUTH">
							<li>
								<a id="Airportway EB to SB" class="locations" href="#">Airport Way East</a>
							</li>
							<li>
								<a id="Airportway WB to SB" class="locations" href="#">Airport Way West</a>
							</li>
							<li>
								<a id="Columbia to I-205 SB" class="locations" href="#">Columbia Blvd</a>
							</li>
							<li>
								<a id="Division SB" class="locations" href="#">Division St</a>
							</li>
							<li>
								<a id="Foster SB" class="locations" href="#">Foster Rd</a>
							</li>
							<li>
								<a id="Glisan to I-205 SB" class="locations" href="#">Glisan St</a>
							</li>
							<li>
								<a id="Johnson Creek SB" class="locations" href="#">Johnson Cr Rd</a>
							</li>
							<li>
								<a id="Powell Blvd SB" class="locations" href="#">Powell Blvd</a>
							</li>
							<li>
								<a id="Stark-Washington SB" class="locations" href="#">Stark St</a>
							</li>
							<li>
								<a id="Sunnyside SB" class="locations" href="#">Sunnyside Rd</a>
							</li>
						</ul>
					</li>
				</ul>
			</li>
		</ul>
	</nav>

	<div id="content">
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<div class="container-fluid">

				<button type="button" id="sidebarCollapse" class="btn btn-info">
					<i class="fas fa-align-left"></i>
					<span>Menu</span>
				</button>
				<button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse"
					data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
					aria-label="Toggle navigation">
					<i class="fas fa-align-justify"></i>
				</button>
				<button class="btn btn-secondary ml-4" type="button" data-toggle="modal"
					data-target="#aboutModal">About</button>

				<div class="modal fade" id="aboutModal">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<h3 class="modal-title">Visualize Traffic from Sensor Data</h3>
							</div>
							<div class="modal-body">
								<p>Using sensors embeded in Portland freeways, observe how traffic flows as
									speed, volume and occupancy are recorded
								</p>
								<p>Choose a location and a day
								</p>
								<h6>Data and Storage</h6>
								<p>Data comes from ...</p>
							</div>
							<div class="modal-footer">
								<button class="btn btn-primary" data-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>

				<div class="collapse navbar-collapse" id="navbarSupportedContent">
					<ul class="nav navbar-nav ml-auto">
						<li class="nav-item">
							<a id="sunday" class="nav-link" href="#">Sunday</a>
						</li>
						<li class="nav-item">
							<a id="monday" class="nav-link" href="#">Monday</a>
						</li>
						<li class="nav-item">
							<a id="tuesday" class="nav-link" href="#">Tuesday</a>
						</li>
						<li class="nav-item">
							<a id="wednesday" class="nav-link" href="#">Wednesday</a>
						</li>
						<li class="nav-item">
							<a id="thursday" class="nav-link" href="#">Thursday</a>
						</li>
						<li class="nav-item">
							<a id="friday" class="nav-link" href="#">Friday</a>
						</li>
						<li class="nav-item">
							<a id="saturday" class="nav-link" href="#">Saturday</a>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<div id="charts-maps" class="container">
			<div class="row row1">
				<div class="col-sm-12 col-md-4 col-lg-4">
					<div class="container" id="satView">
						<img class="card-img-top" id="satImg" alt="" src="">
						<div class="card text-right border-light map-card">
							<div class="card-body">
								<h6 class="card-title" id="satViewTitle"></h6>
								<p id=satview-desc></p>
							</div>
						</div>
					</div>
				</div>
				<div class="col-sm-12 col-md-4 col-lg-4">
					<div class="container" id="volumeChart">
						<div class="card text-right border-light chart-card">
							<canvas id="chartVolume"></canvas>
							<div class="card-body">
								<h6 class="card-title" id="volumeChartTitle"></h6>
								<p id=volume-desc></p>
							</div>
						</div>
					</div>
				</div>
				<div class="col-sm-12 col-md-4 col-lg-4">
					<div class="container" id="streetView">
						<img class="card-img-top" id="streetImg" alt="" src="">
						<div class="card text-center border-light map-card">
							<div class="card-body">
								<h6 class="card-title" id="streetViewTitle"></h6>
								<a id="left" href="#" class="btn btn-primary"><</a>
                    			<a id="right" href="#" class="btn btn-primary">></a>
								<p id=streetview-desc></p>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="row row2">
				<div class="col-sm-12 col-md-12 col-lg-12 col-xl-6">
					<div class="container" id="speedChart">
						<div class="card text-right border-light chart-card">
							<canvas id="chartSpeed"></canvas>
							<div class="card-body">
								<h6 class="card-title" id="speedChartTitle"></h6>
								<p id=speed-desc></p>
							</div>
						</div>
					</div>
				</div>
				<div class="col-sm-12 col-md-12 col-lg-12 col-xl-6">
					<div class="container" id="congestionChart">
						<div class="card text-right border-light chart-card">
							<canvas id="chartCongestion"></canvas>
							<div class="card-body">
								<h6 class="card-title" id="congestionChartTitle"></h6>
								<p id=congestion-desc></p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	</div>

	<script type="text/javascript">
		window.onload = function() {
			document.getElementById("satView").hidden = true;
			document.getElementById("streetView").hidden = true;
			document.getElementById("volumeChart").hidden = true;
			document.getElementById("congestionChart").hidden = true;
			document.getElementById("speedChart").hidden = true;
		};

		let todaysHost = 'http://34.105.22.120';
		let mapsKey = '';
		// on deploy
		// fetch('q1')
		// on development
		// fetch(`${proxyurl}/${todaysHost}/q1`)
		// or if cors used ...
		// fetch(`${todaysHost}/q1`)
		var map;
		var chartSpeed;
		var chartVolume;
		var chartCongestion;
		var locations = document.querySelectorAll(".locations");
		var navlinks = document.querySelectorAll(".nav-link");

		for (let i = 0; i < locations.length; i++) locations[i].onclick = function () {
			let location = this.id;
			let highway = this.parentNode.parentNode.parentNode.parentNode.id;
			let direction = this.parentNode.parentNode.id;

			//a 'to use this api...'
			//icons on highways/locations
			document.getElementById("satView").hidden = false;
			document.getElementById("streetView").hidden = false;
			getMaps(direction, highway, location);
			destroyCharts();

			for (let i = 0; i < navlinks.length; i++) navlinks[i].onclick = function () {
				let actives = document.getElementsByClassName("nav-link active");
				for (let j = 0; j < actives.length; j++) actives[j].classList.remove("active");
				let day = this.id;
				document.getElementById(day).classList.add("active");
				getCharts(direction, highway, location, 1, day);
			}
		}

		function destroyCharts() {
			if (chartVolume != null) chartVolume.destroy();
			if (chartSpeed != null) chartSpeed.destroy();
			if (chartCongestion != null) chartCongestion.destroy();
		}

		document.getElementById("left").addEventListener("click", function () {
			let streetImg = document.getElementById("streetImg");
			let re = /heading=(.)*&pitch/;
			let str = streetImg.src.match(re);
			let oldHeading = str[0].match(/\d+/);
			let newHeading = parseInt(oldHeading[0]) - 30;
			let newCall = streetImg.src.replace(re, "heading=" + newHeading + "&pitch");
			streetImg.src = newCall;
			console.log(newCall);
		});
		document.getElementById("right").addEventListener("click", function () {
			let streetImg = document.getElementById("streetImg");
			let re = /heading=(.)*&pitch/;
			let str = streetImg.src.match(re);
			let oldHeading = str[0].match(/\d+/);
			let newHeading = parseInt(oldHeading[0]) + 30;
			let newCall = streetImg.src.replace(re, "heading=" + newHeading + "&pitch");
			streetImg.src = newCall;
			console.log(newCall);
		});

		function getMaps(direction, highway, location) {
			fetch(`${todaysHost}/map/${direction}/${highway}/${location}`) //on deploy: fetch(`/map/${direction}/${highway}/${location}`)
				.then(response => { return response.json(); })
				.then(data => {
					let width = 800;
					let height = 600;
					let pitch = 0;
					let fov = 120;
					let heading;
					if (direction === 'NORTH') heading = 360;
					else if (direction === 'SOUTH') heading = 180;
					let lat = data.results.rows[0].latlong[0];
					let long = data.results.rows[0].latlong[1]

					let streetImg = document.getElementById("streetImg");
					streetImg.src = `https://maps.googleapis.com/maps/api/streetview?size=${width}x${height}&location=${lat},${long}&heading=${heading}&pitch=${pitch}&fov=${fov}&key=${mapsKey}`
					document.getElementById("streetImg").setAttribute("alt", location + ' street view from google maps');

					let zoom = 20;
					let satImg = document.getElementById("satImg");
					satImg.src = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${long}&zoom=${zoom}&size=${width}x${height}&maptype=hybrid&key=${mapsKey}`;
					document.getElementById("satViewTitle").innerText = location + " on " + highway;
					document.getElementById("satImg").setAttribute("alt", location + ' satellite view from google maps');
					return true;
				})
				.catch(error => {
					console.log('failed', error);
				})
		}

		function createChartVolume(totalVolume) {
			document.getElementById("volumeChart").hidden = false;
			document.getElementById("volumeChartTitle").innerText = "Number of vehicles per day";
			if (chartVolume != null) chartVolume.destroy();
			document.getElementById('chartVolume').getContext('2d').clearRect(0, 0, this.width, this.height);
			chartVolume = new Chart(document.getElementById('chartVolume'), {
				type: 'doughnut',
				data: {
					labels: ['left'],
					datasets: [
						{
							label: 'Volume',
							backgroundColor: ['rgba(0, 0, 255, 0.8)'],
							data: [totalVolume]
						}
					]
				},
				options: {
					title: {
						display: true,
					}
				}
			});
		}

		function createChartSpeed(starttime, speed) {
			document.getElementById("speedChart").hidden = false;
			document.getElementById("speedChartTitle").innerText = "Speed";
			document.getElementById("speed-desc").innerText = "20-second averages in mph";
			if (chartSpeed != null) chartSpeed.destroy();
			chartSpeed = new Chart(document.getElementById("chartSpeed").getContext("2d"), {
				type: 'line',
				data: {
					labels: starttime,
					datasets: [{
						label: 'left',
						data: speed,
						borderColor: 'rgba(0, 0, 255, 0.8)',
						backgroundColor: 'rgba(0, 0, 255, 0.3)',
						fill: false,
						showLine: false,
						pointRadius: 1
					}]
				},
				options: {
					animation: {
						duration: 0
					},
					hover: {
						animationDuration: 0
					},
					responsiveAnimationDuration: 0
				},
				defaults: {
					line: {
						showLine: false,
					}
				}
			});
		}

		function createCongestionChart(starttime, occupancy) {
			document.getElementById("congestionChart").hidden = false;
			document.getElementById("congestionChartTitle").innerText = "Congestion";
			document.getElementById("congestion-desc").innerText = "percentage of time cars are on a sensor";
			if (chartCongestion != null) chartCongestion.destroy();
			document.getElementById('chartCongestion').getContext('2d').clearRect(0, 0, this.width, this.height);
			chartCongestion = new Chart(document.getElementById("chartCongestion").getContext("2d"), {
				type: 'line',
				data: {
					labels: starttime,
					datasets: [{
						label: 'left',
						data: occupancy,
						borderColor: 'rgba(0, 0, 255, 0.8)',
						backgroundColor: 'rgba(0, 0, 255, 0.3)',
						fill: false,
						showLine: true,
						pointRadius: 1
					}]
				},
				options: {
					animation: {
						duration: 0.3
					},
					hover: {
						animationDuration: 0
					},
					responsiveAnimationDuration: 0
				},
				defaults: {
					line: {
						showLine: true,
					}
				}
			});
		}

		function getCharts(direction, highway, location, lane, day) {
			fetch(`${todaysHost}/data/${direction}/${highway}/${location}/${lane}/${day}`) //on deploy: fetch('data/${direction}/${highway}/${location}/${lane}/${day}')
				.then(response => { return response.json(); })
				.then(data => {
					returnedRows = data.results.rows;
					starttime = [];
					starttime = returnedRows.map(x => moment.utc((x['starttime'])).format('h:mm a'));
					speed = [];
					speed = returnedRows.map(x => x['speed']);
					volume = [];
					totalVolume = 0;
					volume = returnedRows.map(x => x['volume']);
					volume.forEach(v => totalVolume += v);
					occupancy = [];
					occupancy = returnedRows.map(x => x['occupancy']);
					let segment = Math.floor(occupancy.length/48);
					occupancyAvg = [];
					for(let i = 0; i < occupancy.length; i+=segment) {
						let tempBin = 0;
						for(let j = i; j < i + segment; j++) {
							tempBin += occupancy[j];
						}
						occupancyAvg.push(Math.round(tempBin /= segment));
					}
					timeSlices = [];
					for(let i = 0; i < starttime.length; i+=segment) {
						timeSlices.push(starttime[i]);
					}

					createChartSpeed(starttime, speed);
					createCongestionChart(timeSlices, occupancyAvg);
					createChartVolume(totalVolume);

					return fetch(`${todaysHost}/data/${direction}/${highway}/${location}/${lane + 1}/${day}`) //on deploy: fetch('data/${direction}/${highway}/${location}/${lane}/${day}')
				})
				.then(response => { return response.json(); })
				.then(data => {
					returnedRows = data.results.rows;
					speed = [];
					speed = returnedRows.map(x => x['speed']);
					volume = [];
					totalVolume = 0;
					volume = returnedRows.map(x => x['volume']);
					volume.forEach(v => totalVolume += v);
					occupancy = returnedRows.map(x => x['occupancy']);
					let segment = Math.floor(occupancy.length/48);
					occupancyAvg = [];
					for(let i = 0; i < occupancy.length; i+=segment) {
						let tempBin = 0;
						for(let j = i; j < i + segment; j++) {
							tempBin += occupancy[j];
						}
						occupancyAvg.push(Math.round(tempBin /= segment));
					}

					anotherSpeed = {
						label: 'middle',
						data: speed,
						borderColor: 'rgba(0, 255, 0, 0.8)',
						backgroundColor: 'rgba(0, 255, 0, 0.3)',
						fill: false,
						showLine: false,
						pointRadius: 1
					}
					label = 'middle';
					backgroundColor = 'rgba(0, 255, 0, 0.8)';
					anotherCongestion = {
						label: 'middle lane',
						data: occupancyAvg,
						borderColor: 'rgba(0, 255, 0, 0.8)',
						backgroundColor: 'rgba(0, 255, 0, 0.3)',
						fill: false,
						showLine: true,
						pointRadius: 1
					}

					chartSpeed.data.datasets.push(anotherSpeed);
					chartSpeed.update(0);
					chartVolume.data.labels.push(label);
					chartVolume.data.datasets[0].data.push(totalVolume);
					chartVolume.data.datasets[0].backgroundColor.push(backgroundColor);
					chartVolume.update(0);
					chartCongestion.data.datasets.push(anotherCongestion);
					chartCongestion.update(0);
					return fetch(`${todaysHost}/data/${direction}/${highway}/${location}/${lane + 2}/${day}`) //on deploy: fetch('data/${direction}/${highway}/${location}/${lane+3}/${day}')
				})
				.then(response => { return response.json(); })
				.then(data => {
					returnedRows = data.results.rows;
					speed = [];
					speed = returnedRows.map(x => x['speed']);
					volume = [];
					totalVolume = 0;
					volume = returnedRows.map(x => x['volume']);
					volume.forEach(v => totalVolume += v);
					occupancy = returnedRows.map(x => x['occupancy']);
					let segment = Math.floor(occupancy.length/48);
					occupancyAvg = [];
					for(let i = 0; i < occupancy.length; i+=segment) {
						let tempBin = 0;
						for(let j = i; j < i + segment; j++) {
							tempBin += occupancy[j];
						}
						occupancyAvg.push(Math.round(tempBin /= segment));
					}

					anotherSpeed = {
						label: 'right',
						data: speed,
						borderColor: 'rgba(255, 0, 0, 0.8)',
						backgroundColor: 'rgba(255, 0, 0, 0.3)',
						fill: false,
						showLine: false,
						pointRadius: 1
					}
					label = 'right';
					backgroundColor = 'rgba(255, 0, 0, 0.8)';
					anotherCongestion = {
						label: 'right',
						data: occupancyAvg,
						borderColor: 'rgba(255, 0, 0, 0.8)',
						backgroundColor: 'rgba(255, 0, 0, 0.3)',
						fill: false,
						showLine: true,
						pointRadius: 1
					}

					chartSpeed.data.datasets.push(anotherSpeed);
					chartSpeed.update(0);
					chartVolume.data.labels.push(label);
					chartVolume.data.datasets[0].data.push(totalVolume);
					chartVolume.data.datasets[0].backgroundColor.push(backgroundColor);
					chartVolume.update(0);
					chartCongestion.data.datasets.push(anotherCongestion);
					chartCongestion.update(0);
				})
				.catch(error => {
					console.log('failed', error)
				})
		}
	</script>

	<!-- jQuery CDN - Slim version (=without AJAX) -->
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
		integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
		crossorigin="anonymous"></script>
	<!-- Popper.JS -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"
		integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
		crossorigin="anonymous"></script>
	<!-- Bootstrap JS -->
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"
		integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
		crossorigin="anonymous"></script>
	<!-- jQuery Custom Scroller CDN -->
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>

	<script type="text/javascript">
		$(document).ready(function () {
			$("#sidebar").mCustomScrollbar({
				theme: "minimal"
			});

			$('#sidebarCollapse').on('click', function () {
				$('#sidebar, #content').toggleClass('active');
				$('.collapse.in').toggleClass('in');
				$('a[aria-expanded=true]').attr('aria-expanded', 'false');
			});
		});
	</script>
</body>
</html>